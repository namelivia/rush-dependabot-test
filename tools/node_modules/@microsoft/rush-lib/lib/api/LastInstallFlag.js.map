{"version":3,"file":"LastInstallFlag.js","sourceRoot":"","sources":["../../src/api/LastInstallFlag.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\n\nimport { FileSystem, JsonFile, JsonObject, Import } from '@rushstack/node-core-library';\n\nimport { PackageManagerName } from './packageManager/PackageManager';\nimport { RushConfiguration } from './RushConfiguration';\n\nconst lodash: typeof import('lodash') = Import.lazy('lodash', require);\n\nexport const LAST_INSTALL_FLAG_FILE_NAME: string = 'last-install.flag';\n\n/**\n * A helper class for managing last-install flags, which are persistent and\n * indicate that something installed in the folder was successfully completed.\n * It also compares state, so that if something like the Node.js version has changed,\n * it can invalidate the last install.\n * @internal\n */\nexport class LastInstallFlag {\n  private _path: string;\n  private _state: JsonObject;\n\n  /**\n   * Creates a new LastInstall flag\n   * @param folderPath - the folder that this flag is managing\n   * @param state - optional, the state that should be managed or compared\n   */\n  public constructor(folderPath: string, state: JsonObject = {}) {\n    this._path = path.join(folderPath, this.flagName);\n    this._state = state;\n  }\n\n  /**\n   * Returns true if the file exists and the contents match the current state.\n   */\n  public isValid(): boolean {\n    return this._isValid(false);\n  }\n\n  /**\n   * Same as isValid(), but with an additional check:  If the current state is not equal to the previous\n   * state, and an the current state causes an error, then throw an exception with a friendly message.\n   *\n   * @internal\n   */\n  public checkValidAndReportStoreIssues(): boolean {\n    return this._isValid(true);\n  }\n\n  private _isValid(checkValidAndReportStoreIssues: boolean): boolean {\n    let oldState: JsonObject;\n    try {\n      oldState = JsonFile.load(this._path);\n    } catch (err) {\n      return false;\n    }\n\n    const newState: JsonObject = this._state;\n\n    if (!lodash.isEqual(oldState, newState)) {\n      if (checkValidAndReportStoreIssues) {\n        const pkgManager: PackageManagerName = newState.packageManager;\n        if (pkgManager === 'pnpm') {\n          if (\n            // Only throw an error if the package manager hasn't changed from PNPM\n            oldState.packageManager === pkgManager &&\n            // Throw if the store path changed\n            oldState.storePath !== newState.storePath\n          ) {\n            const oldStorePath: string = oldState.storePath || '<global>';\n            const newStorePath: string = newState.storePath || '<global>';\n\n            throw new Error(\n              'Current PNPM store path does not match the last one used. This may cause inconsistency in your builds.\\n\\n' +\n                'If you wish to install with the new store path, please run \"rush update --purge\"\\n\\n' +\n                `Old Path: ${oldStorePath}\\n` +\n                `New Path: ${newStorePath}`\n            );\n          }\n        }\n      }\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Writes the flag file to disk with the current state\n   */\n  public create(): void {\n    JsonFile.save(this._state, this._path, {\n      ensureFolderExists: true\n    });\n  }\n\n  /**\n   * Removes the flag file\n   */\n  public clear(): void {\n    FileSystem.deleteFile(this._path);\n  }\n\n  /**\n   * Returns the full path to the flag file\n   */\n  public get path(): string {\n    return this._path;\n  }\n\n  /**\n   * Returns the name of the flag file\n   */\n  protected get flagName(): string {\n    return LAST_INSTALL_FLAG_FILE_NAME;\n  }\n}\n\n/**\n * A helper class for LastInstallFlag\n *\n * @internal\n */\nexport class LastInstallFlagFactory {\n  /**\n   * Gets the LastInstall flag and sets the current state. This state is used to compare\n   * against the last-known-good state tracked by the LastInstall flag.\n   * @param rushConfiguration - the configuration of the Rush repo to get the install\n   * state from\n   *\n   * @internal\n   */\n  public static getCommonTempFlag(rushConfiguration: RushConfiguration): LastInstallFlag {\n    const currentState: JsonObject = {\n      node: process.versions.node,\n      packageManager: rushConfiguration.packageManager,\n      packageManagerVersion: rushConfiguration.packageManagerToolVersion,\n      rushJsonFolder: rushConfiguration.rushJsonFolder\n    };\n\n    if (currentState.packageManager === 'pnpm' && rushConfiguration.pnpmOptions) {\n      currentState.storePath = rushConfiguration.pnpmOptions.pnpmStorePath;\n      if (rushConfiguration.pnpmOptions.useWorkspaces) {\n        currentState.workspaces = rushConfiguration.pnpmOptions.useWorkspaces;\n      }\n    }\n\n    return new LastInstallFlag(rushConfiguration.commonTempFolder, currentState);\n  }\n}\n"]}