{"version":3,"file":"TempProjectHelper.js","sourceRoot":"","sources":["../../src/logic/TempProjectHelper.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,oEAAwF;AACxF,yCAA2B;AAC3B,2CAA6B;AAI7B,mDAAgD;AAEhD,qEAAqE;AACrE,+BAA+B;AAE/B,MAAa,iBAAiB;IAG5B,YAAmB,iBAAoC;QACrD,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;IAC9C,CAAC;IAED;;OAEG;IACI,wBAAwB,CAAC,WAAqC;QACnE,8BAAU,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,EAAE,UAAU,CAAC,CAAC,CAAC;QAC5F,MAAM,WAAW,GAAW,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,CAAC;QACjE,MAAM,iBAAiB,GAAW,IAAI,CAAC,oBAAoB,CAAC,WAAW,CAAC,CAAC;QAEzE,8BAAU,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;QAEnC,2EAA2E;QAC3E,MAAM,gBAAgB,GAAW,SAAS,CAAC;QAE3C,MAAM,UAAU,GAAsB;YACpC,IAAI,EAAE,IAAI;YACV,IAAI,EAAE,WAAW;YACjB,GAAG,EAAE,iBAAiB;YACtB,QAAQ,EAAE,IAAI;YACd,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,IAAI;YACX,IAAI,EAAE,IAAI;YACV,MAAM,EAAE,gBAAgB;YACxB,MAAM,EAAE,CAAC,IAAY,EAAE,IAAkB,EAAW,EAAE;gBACpD,IACE,CAAC,IAAI,CAAC,kBAAkB,CAAC,wBAAwB,CAAC,aAAa,CAAC,oCAAoC,EACpG;oBACA,IAAI,CAAC,IAAI;wBACP,CAAC,IAAI,CAAC,IAAI,GAAG,CAAC,KAAK,CAAC,GAAG,iCAAa,CAAC,OAAO,GAAG,iCAAa,CAAC,SAAS,GAAG,iCAAa,CAAC,UAAU,CAAC;iBACrG;gBACD,OAAO,IAAI,CAAC;YACd,CAAC;SACmB,CAAC;QACvB,yBAAyB;QACzB,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC,iCAAa,CAAC,WAAW,CAAC,CAAC,CAAC;IACtD,CAAC;IAED;;;OAGG;IACI,kBAAkB,CAAC,OAAiC;QACzD,OAAO,IAAI,CAAC,IAAI,CACd,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,EACxC,6BAAa,CAAC,0BAA0B,EACxC,GAAG,OAAO,CAAC,uBAAuB,MAAM,CACzC,CAAC;IACJ,CAAC;IAEM,oBAAoB,CAAC,WAAqC;QAC/D,MAAM,uBAAuB,GAAW,WAAW,CAAC,uBAAuB,CAAC;QAC5E,OAAO,IAAI,CAAC,IAAI,CACd,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,EACxC,6BAAa,CAAC,0BAA0B,EACxC,uBAAuB,CACxB,CAAC;IACJ,CAAC;CACF;AA/DD,8CA+DC","sourcesContent":["import { FileConstants, FileSystem, PosixModeBits } from '@rushstack/node-core-library';\nimport * as tar from 'tar';\nimport * as path from 'path';\n\nimport { RushConfigurationProject } from '../api/RushConfigurationProject';\nimport { RushConfiguration } from '../api/RushConfiguration';\nimport { RushConstants } from './RushConstants';\n\n// The PosixModeBits are intended to be used with bitwise operations.\n/* eslint-disable no-bitwise */\n\nexport class TempProjectHelper {\n  private _rushConfiguration: RushConfiguration;\n\n  public constructor(rushConfiguration: RushConfiguration) {\n    this._rushConfiguration = rushConfiguration;\n  }\n\n  /**\n   * Deletes the existing tarball and creates a tarball for the given rush project\n   */\n  public createTempProjectTarball(rushProject: RushConfigurationProject): void {\n    FileSystem.ensureFolder(path.resolve(this._rushConfiguration.commonTempFolder, 'projects'));\n    const tarballFile: string = this.getTarballFilePath(rushProject);\n    const tempProjectFolder: string = this.getTempProjectFolder(rushProject);\n\n    FileSystem.deleteFile(tarballFile);\n\n    // NPM expects the root of the tarball to have a directory called 'package'\n    const npmPackageFolder: string = 'package';\n\n    const tarOptions: tar.CreateOptions = {\n      gzip: true,\n      file: tarballFile,\n      cwd: tempProjectFolder,\n      portable: true,\n      noMtime: true,\n      noPax: true,\n      sync: true,\n      prefix: npmPackageFolder,\n      filter: (path: string, stat: tar.FileStat): boolean => {\n        if (\n          !this._rushConfiguration.experimentsConfiguration.configuration.noChmodFieldInTarHeaderNormalization\n        ) {\n          stat.mode =\n            (stat.mode & ~0x1ff) | PosixModeBits.AllRead | PosixModeBits.UserWrite | PosixModeBits.AllExecute;\n        }\n        return true;\n      }\n    } as tar.CreateOptions;\n    // create the new tarball\n    tar.create(tarOptions, [FileConstants.PackageJson]);\n  }\n\n  /**\n   * Gets the path to the tarball\n   * Example: \"C:\\MyRepo\\common\\temp\\projects\\my-project-2.tgz\"\n   */\n  public getTarballFilePath(project: RushConfigurationProject): string {\n    return path.join(\n      this._rushConfiguration.commonTempFolder,\n      RushConstants.rushTempProjectsFolderName,\n      `${project.unscopedTempProjectName}.tgz`\n    );\n  }\n\n  public getTempProjectFolder(rushProject: RushConfigurationProject): string {\n    const unscopedTempProjectName: string = rushProject.unscopedTempProjectName;\n    return path.join(\n      this._rushConfiguration.commonTempFolder,\n      RushConstants.rushTempProjectsFolderName,\n      unscopedTempProjectName\n    );\n  }\n}\n"]}