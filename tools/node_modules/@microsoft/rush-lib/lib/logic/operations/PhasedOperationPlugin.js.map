{"version":3,"file":"PhasedOperationPlugin.js","sourceRoot":"","sources":["../../../src/logic/operations/PhasedOperationPlugin.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport type { RushConfigurationProject } from '../../api/RushConfigurationProject';\nimport type { IPhase } from '../../api/CommandLineConfiguration';\n\nimport { Operation } from './Operation';\nimport { OperationStatus } from './OperationStatus';\nimport { NullOperationRunner } from './NullOperationRunner';\nimport type {\n  ICreateOperationsContext,\n  IPhasedCommandPlugin,\n  PhasedCommandHooks\n} from '../../pluginFramework/PhasedCommandHooks';\n\nconst PLUGIN_NAME: 'PhasedOperationPlugin' = 'PhasedOperationPlugin';\n\n/**\n * Core phased command plugin that provides the functionality for generating a base operation graph\n * from the set of selected projects and phases.\n */\nexport class PhasedOperationPlugin implements IPhasedCommandPlugin {\n  public apply(hooks: PhasedCommandHooks): void {\n    hooks.createOperations.tap(PLUGIN_NAME, createOperations);\n  }\n}\n\nfunction createOperations(\n  existingOperations: Set<Operation>,\n  context: ICreateOperationsContext\n): Set<Operation> {\n  const { projectsInUnknownState: changedProjects, phaseSelection, projectSelection } = context;\n  const operationsWithWork: Set<Operation> = new Set();\n\n  const operations: Map<string, Operation> = new Map();\n\n  // Create tasks for selected phases and projects\n  for (const phase of phaseSelection) {\n    for (const project of projectSelection) {\n      getOrCreateOperation(phase, project);\n    }\n  }\n\n  // Recursively expand all consumers in the `operationsWithWork` set.\n  for (const operation of operationsWithWork) {\n    for (const consumer of operation.consumers) {\n      operationsWithWork.add(consumer);\n    }\n  }\n\n  for (const [key, operation] of operations) {\n    if (!operationsWithWork.has(operation)) {\n      // This operation is in scope, but did not change since it was last executed by the current command.\n      // However, we have no state tracking across executions, so treat as unknown.\n      operation.runner = new NullOperationRunner({\n        name: key,\n        result: OperationStatus.Skipped,\n        silent: true\n      });\n    }\n  }\n\n  return existingOperations;\n\n  // Binds phaseSelection, projectSelection, operations via closure\n  function getOrCreateOperation(phase: IPhase, project: RushConfigurationProject): Operation {\n    const key: string = getOperationKey(phase, project);\n    let operation: Operation | undefined = operations.get(key);\n    if (!operation) {\n      operation = new Operation({\n        project,\n        phase\n      });\n\n      if (!phaseSelection.has(phase) || !projectSelection.has(project)) {\n        // Not in scope. Mark skipped because state is unknown.\n        operation.runner = new NullOperationRunner({\n          name: key,\n          result: OperationStatus.Skipped,\n          silent: true\n        });\n      } else if (changedProjects.has(project)) {\n        operationsWithWork.add(operation);\n      }\n\n      operations.set(key, operation);\n      existingOperations.add(operation);\n\n      const {\n        dependencies: { self, upstream }\n      } = phase;\n\n      for (const depPhase of self) {\n        operation.addDependency(getOrCreateOperation(depPhase, project));\n      }\n\n      if (upstream.size) {\n        const { dependencyProjects } = project;\n        if (dependencyProjects.size) {\n          for (const depPhase of upstream) {\n            for (const dependencyProject of dependencyProjects) {\n              operation.addDependency(getOrCreateOperation(depPhase, dependencyProject));\n            }\n          }\n        }\n      }\n    }\n\n    return operation;\n  }\n}\n\n// Convert the [IPhase, RushConfigurationProject] into a value suitable for use as a Map key\nfunction getOperationKey(phase: IPhase, project: RushConfigurationProject): string {\n  return `${project.packageName};${phase.name}`;\n}\n"]}