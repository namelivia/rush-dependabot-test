{"version":3,"file":"DeployArchiver.js","sourceRoot":"","sources":["../../../src/logic/deploy/DeployArchiver.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport JSZip = require('jszip');\n\nimport * as path from 'path';\nimport { FileSystem, FileSystemStats, Path } from '@rushstack/node-core-library';\n\nimport { IDeployState } from './DeployManager';\n\nexport class DeployArchiver {\n  public static async createArchiveAsync(deployState: IDeployState): Promise<void> {\n    if (deployState.createArchiveFilePath !== undefined) {\n      console.log('Creating archive...');\n      const zip: JSZip = this._getZipOfFolder(deployState.targetRootFolder);\n      const zipContent: Buffer = await zip.generateAsync({\n        type: 'nodebuffer',\n        platform: 'UNIX'\n      });\n\n      FileSystem.writeFile(\n        path.resolve(deployState.targetRootFolder, deployState.createArchiveFilePath),\n        zipContent\n      );\n\n      console.log('Archive created successfully.');\n    }\n  }\n\n  private static _getFilePathsRecursively(dir: string): string[] {\n    // returns a flat array of absolute paths of all files recursively contained in the dir\n    let results: string[] = [];\n    const list: string[] = FileSystem.readFolderItemNames(dir);\n\n    if (!list.length) return results;\n\n    for (let file of list) {\n      file = path.resolve(dir, file);\n\n      const stat: FileSystemStats = FileSystem.getLinkStatistics(file);\n\n      if (stat && stat.isDirectory()) {\n        results = results.concat(this._getFilePathsRecursively(file));\n      } else {\n        results.push(file);\n      }\n    }\n\n    return results;\n  }\n\n  private static _getZipOfFolder(dir: string): JSZip {\n    // returns a JSZip instance filled with contents of dir.\n    const allPaths: string[] = this._getFilePathsRecursively(dir);\n\n    // This value sets the allowed permissions when preserving symbolic links.\n    // 120000 is the symbolic link identifier, and 0755 designates the allowed permissions.\n    // See: https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/stat.h#n10\n    const permissionsValue: number = 0o120755;\n\n    const zip: JSZip = new JSZip();\n    for (const filePath of allPaths) {\n      // Get the relative path and replace backslashes for Unix compat\n      const addPath: string = Path.convertToSlashes(path.relative(dir, filePath));\n      const stat: FileSystemStats = FileSystem.getLinkStatistics(filePath);\n      const permissions: number = stat.mode;\n\n      if (stat.isSymbolicLink()) {\n        zip.file(addPath, FileSystem.readLink(filePath), {\n          unixPermissions: permissionsValue,\n          dir: stat.isDirectory()\n        });\n      } else {\n        const data: Buffer = FileSystem.readFileToBuffer(filePath);\n        zip.file(addPath, data, {\n          unixPermissions: permissions,\n          dir: stat.isDirectory()\n        });\n      }\n    }\n\n    return zip;\n  }\n}\n"]}