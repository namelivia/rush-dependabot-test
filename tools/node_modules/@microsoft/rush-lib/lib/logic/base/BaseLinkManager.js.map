{"version":3,"file":"BaseLinkManager.js","sourceRoot":"","sources":["../../../src/logic/base/BaseLinkManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport colors from 'colors/safe';\nimport * as os from 'os';\nimport * as path from 'path';\n\nimport {\n  FileSystem,\n  FileSystemStats,\n  IFileSystemCreateLinkOptions,\n  InternalError\n} from '@rushstack/node-core-library';\n\nimport { RushConfiguration } from '../../api/RushConfiguration';\nimport { Utilities } from '../../utilities/Utilities';\nimport { Stopwatch } from '../../utilities/Stopwatch';\nimport { BasePackage } from './BasePackage';\nimport { EnvironmentConfiguration } from '../../api/EnvironmentConfiguration';\nimport { LastLinkFlagFactory } from '../../api/LastLinkFlag';\n\nexport enum SymlinkKind {\n  File,\n  Directory\n}\n\nexport interface IBaseLinkManagerCreateSymlinkOptions extends IFileSystemCreateLinkOptions {\n  symlinkKind: SymlinkKind;\n}\n\nexport abstract class BaseLinkManager {\n  protected _rushConfiguration: RushConfiguration;\n\n  public constructor(rushConfiguration: RushConfiguration) {\n    this._rushConfiguration = rushConfiguration;\n  }\n\n  protected static _createSymlink(options: IBaseLinkManagerCreateSymlinkOptions): void {\n    const newLinkFolder: string = path.dirname(options.newLinkPath);\n    FileSystem.ensureFolder(newLinkFolder);\n\n    let targetPath: string;\n    if (EnvironmentConfiguration.absoluteSymlinks) {\n      targetPath = options.linkTargetPath;\n    } else {\n      // Link to the relative path, to avoid going outside containers such as a Docker image\n      targetPath = path.relative(FileSystem.getRealPath(newLinkFolder), options.linkTargetPath);\n    }\n\n    if (process.platform === 'win32') {\n      if (options.symlinkKind === SymlinkKind.Directory) {\n        // For directories, we use a Windows \"junction\".  On Unix, this produces a regular symlink.\n        FileSystem.createSymbolicLinkJunction({\n          linkTargetPath: targetPath,\n          newLinkPath: options.newLinkPath\n        });\n      } else {\n        // For files, we use a Windows \"hard link\", because creating a symbolic link requires\n        // administrator permission.\n\n        // NOTE: We cannot use the relative path for hard links\n        FileSystem.createHardLink({\n          linkTargetPath: options.linkTargetPath,\n          newLinkPath: options.newLinkPath\n        });\n      }\n    } else {\n      // However hard links seem to cause build failures on Mac, so for all other operating systems\n      // we use symbolic links for this case.\n      if (options.symlinkKind === SymlinkKind.Directory) {\n        FileSystem.createSymbolicLinkFolder({\n          linkTargetPath: targetPath,\n          newLinkPath: options.newLinkPath\n        });\n      } else {\n        FileSystem.createSymbolicLinkFile({\n          linkTargetPath: targetPath,\n          newLinkPath: options.newLinkPath\n        });\n      }\n    }\n  }\n\n  /**\n   * For a Package object that represents a top-level Rush project folder\n   * (i.e. with source code that we will be building), this clears out its\n   * node_modules folder and then recursively creates all the symlinked folders.\n   */\n  protected static _createSymlinksForTopLevelProject(localPackage: BasePackage): void {\n    const localModuleFolder: string = path.join(localPackage.folderPath, 'node_modules');\n\n    // Sanity check\n    if (localPackage.parent) {\n      throw new Error('The provided package is not a top-level project');\n    }\n\n    // The root-level folder is the project itself, so we simply delete its node_modules\n    // to start clean\n    console.log('Purging ' + localModuleFolder);\n    Utilities.dangerouslyDeletePath(localModuleFolder);\n\n    if (localPackage.children.length > 0) {\n      Utilities.createFolderWithRetry(localModuleFolder);\n\n      for (const child of localPackage.children) {\n        BaseLinkManager._createSymlinksForDependencies(child);\n      }\n    }\n  }\n\n  /**\n   * This is a helper function used by createSymlinksForTopLevelProject().\n   * It will recursively creates symlinked folders corresponding to each of the\n   * Package objects in the provided tree.\n   */\n  private static _createSymlinksForDependencies(localPackage: BasePackage): void {\n    const localModuleFolder: string = path.join(localPackage.folderPath, 'node_modules');\n\n    if (!localPackage.symlinkTargetFolderPath) {\n      throw new InternalError('localPackage.symlinkTargetFolderPath was not assigned');\n    }\n\n    // This is special case for when localPackage.name has the form '@scope/name',\n    // in which case we need to create the '@scope' folder first.\n    const parentFolderPath: string = path.dirname(localPackage.folderPath);\n    if (parentFolderPath && parentFolderPath !== localPackage.folderPath) {\n      if (!FileSystem.exists(parentFolderPath)) {\n        Utilities.createFolderWithRetry(parentFolderPath);\n      }\n    }\n\n    if (localPackage.children.length === 0) {\n      // If there are no children, then we can symlink the entire folder\n      BaseLinkManager._createSymlink({\n        linkTargetPath: localPackage.symlinkTargetFolderPath,\n        newLinkPath: localPackage.folderPath,\n        symlinkKind: SymlinkKind.Directory\n      });\n    } else {\n      // If there are children, then we need to symlink each item in the folder individually\n      Utilities.createFolderWithRetry(localPackage.folderPath);\n\n      for (const filename of FileSystem.readFolderItemNames(localPackage.symlinkTargetFolderPath)) {\n        if (filename.toLowerCase() !== 'node_modules') {\n          // Create the symlink\n          let symlinkKind: SymlinkKind = SymlinkKind.File;\n\n          const linkSource: string = path.join(localPackage.folderPath, filename);\n          let linkTarget: string = path.join(localPackage.symlinkTargetFolderPath, filename);\n\n          const linkStats: FileSystemStats = FileSystem.getLinkStatistics(linkTarget);\n\n          if (linkStats.isSymbolicLink()) {\n            const targetStats: FileSystemStats = FileSystem.getStatistics(FileSystem.getRealPath(linkTarget));\n            if (targetStats.isDirectory()) {\n              // Neither a junction nor a directory-symlink can have a directory-symlink\n              // as its target; instead, we must obtain the real physical path.\n              // A junction can link to another junction.  Unfortunately, the node 'fs' API\n              // lacks the ability to distinguish between a junction and a directory-symlink\n              // (even though it has the ability to create them both), so the safest policy\n              // is to always make a junction and always to the real physical path.\n              linkTarget = FileSystem.getRealPath(linkTarget);\n              symlinkKind = SymlinkKind.Directory;\n            }\n          } else if (linkStats.isDirectory()) {\n            symlinkKind = SymlinkKind.Directory;\n          }\n\n          BaseLinkManager._createSymlink({\n            linkTargetPath: linkTarget,\n            newLinkPath: linkSource,\n            symlinkKind\n          });\n        }\n      }\n    }\n\n    if (localPackage.children.length > 0) {\n      Utilities.createFolderWithRetry(localModuleFolder);\n\n      for (const child of localPackage.children) {\n        BaseLinkManager._createSymlinksForDependencies(child);\n      }\n    }\n  }\n\n  /**\n   * Creates node_modules symlinks for all Rush projects defined in the RushConfiguration.\n   * @param force - Normally the operation will be skipped if the links are already up to date;\n   *   if true, this option forces the links to be recreated.\n   */\n  public async createSymlinksForProjects(force: boolean): Promise<void> {\n    console.log(os.EOL + colors.bold('Linking local projects'));\n    const stopwatch: Stopwatch = Stopwatch.start();\n\n    await this._linkProjects();\n\n    // TODO: Remove when \"rush link\" and \"rush unlink\" are deprecated\n    LastLinkFlagFactory.getCommonTempFlag(this._rushConfiguration).create();\n\n    stopwatch.stop();\n    console.log(os.EOL + colors.green(`Linking finished successfully. (${stopwatch.toString()})`));\n    console.log(os.EOL + 'Next you should probably run \"rush build\" or \"rush rebuild\"');\n  }\n\n  protected abstract _linkProjects(): Promise<void>;\n}\n"]}