{"version":3,"file":"PublishGit.js","sourceRoot":"","sources":["../../src/logic/PublishGit.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport { PublishUtilities } from './PublishUtilities';\nimport { Utilities } from '../utilities/Utilities';\nimport { RushConfigurationProject } from '../api/RushConfigurationProject';\nimport { Git } from './Git';\n\nconst DUMMY_BRANCH_NAME: string = '-branch-name-';\n\nexport class PublishGit {\n  private readonly _targetBranch: string | undefined;\n  private readonly _gitPath: string;\n  private readonly _gitTagSeparator: string;\n\n  public constructor(git: Git, targetBranch: string | undefined) {\n    this._targetBranch = targetBranch;\n    this._gitPath = git.getGitPathOrThrow();\n    this._gitTagSeparator = git.getTagSeparator();\n  }\n\n  public checkout(branchName: string | undefined, createBranch: boolean = false): void {\n    const params: string[] = ['checkout'];\n    if (createBranch) {\n      params.push('-b');\n    }\n\n    params.push(branchName || DUMMY_BRANCH_NAME);\n\n    PublishUtilities.execCommand(!!this._targetBranch, this._gitPath, params);\n  }\n\n  public merge(branchName: string, verify: boolean = false): void {\n    PublishUtilities.execCommand(!!this._targetBranch, this._gitPath, [\n      'merge',\n      branchName,\n      '--no-edit',\n      ...(verify ? [] : ['--no-verify'])\n    ]);\n  }\n\n  public deleteBranch(\n    branchName: string | undefined,\n    hasRemote: boolean = true,\n    verify: boolean = false\n  ): void {\n    if (!branchName) {\n      branchName = DUMMY_BRANCH_NAME;\n    }\n\n    PublishUtilities.execCommand(!!this._targetBranch, this._gitPath, ['branch', '-d', branchName]);\n    if (hasRemote) {\n      PublishUtilities.execCommand(!!this._targetBranch, this._gitPath, [\n        'push',\n        'origin',\n        '--delete',\n        branchName,\n        ...(verify ? [] : ['--no-verify'])\n      ]);\n    }\n  }\n\n  public pull(verify: boolean = false): void {\n    const params: string[] = ['pull', 'origin'];\n    if (this._targetBranch) {\n      params.push(this._targetBranch);\n    }\n    if (!verify) {\n      params.push('--no-verify');\n    }\n\n    PublishUtilities.execCommand(!!this._targetBranch, this._gitPath, params);\n  }\n\n  public fetch(): void {\n    PublishUtilities.execCommand(!!this._targetBranch, this._gitPath, ['fetch', 'origin']);\n  }\n\n  public addChanges(pathspec?: string, workingDirectory?: string): void {\n    const files: string = pathspec ? pathspec : '.';\n    PublishUtilities.execCommand(\n      !!this._targetBranch,\n      this._gitPath,\n      ['add', files],\n      workingDirectory ? workingDirectory : process.cwd()\n    );\n  }\n\n  public addTag(\n    shouldExecute: boolean,\n    packageName: string,\n    packageVersion: string,\n    commitId: string | undefined,\n    preReleaseName?: string\n  ): void {\n    // Tagging only happens if we're publishing to real NPM and committing to git.\n    const tagName: string = PublishUtilities.createTagname(\n      packageName,\n      packageVersion,\n      this._gitTagSeparator\n    );\n    PublishUtilities.execCommand(!!this._targetBranch && shouldExecute, this._gitPath, [\n      'tag',\n      '-a',\n      preReleaseName ? `${tagName}-${preReleaseName}` : tagName,\n      '-m',\n      preReleaseName\n        ? `${packageName} v${packageVersion}-${preReleaseName}`\n        : `${packageName} v${packageVersion}`,\n      ...(commitId ? [commitId] : [])\n    ]);\n  }\n\n  public hasTag(packageConfig: RushConfigurationProject): boolean {\n    const tagName: string = PublishUtilities.createTagname(\n      packageConfig.packageName,\n      packageConfig.packageJson.version,\n      this._gitTagSeparator\n    );\n    const tagOutput: string = Utilities.executeCommandAndCaptureOutput(\n      this._gitPath,\n      ['tag', '-l', tagName],\n      packageConfig.projectFolder,\n      PublishUtilities.getEnvArgs(),\n      true\n    ).replace(/(\\r\\n|\\n|\\r)/gm, '');\n\n    return tagOutput === tagName;\n  }\n\n  public commit(commitMessage: string, verify: boolean = false): void {\n    PublishUtilities.execCommand(!!this._targetBranch, this._gitPath, [\n      'commit',\n      '-m',\n      commitMessage,\n      ...(verify ? [] : ['--no-verify'])\n    ]);\n  }\n\n  public push(branchName: string | undefined, verify: boolean = false): void {\n    PublishUtilities.execCommand(\n      !!this._targetBranch,\n      this._gitPath,\n      // We append \"--no-verify\" to prevent Git hooks from running.  For example, people may\n      // want to invoke \"rush change -v\" as a pre-push hook.\n      [\n        'push',\n        'origin',\n        `HEAD:${branchName || DUMMY_BRANCH_NAME}`,\n        '--follow-tags',\n        '--verbose',\n        ...(verify ? [] : ['--no-verify'])\n      ]\n    );\n  }\n}\n"]}