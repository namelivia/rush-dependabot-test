{"version":3,"file":"RushAzureStorageBuildCachePlugin.js","sourceRoot":"","sources":["../src/RushAzureStorageBuildCachePlugin.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;AAE3D,oEAAsD;AAItD,MAAM,oCAAoC,GAAsD,0BAAM,CAAC,IAAI,CACzG,kCAAkC,EAClC,OAAO,CACR,CAAC;AAEF,MAAM,WAAW,GAAW,8BAA8B,CAAC;AAgC3D;;GAEG;AACH,MAAa,gCAAgC;IAA7C;QACS,eAAU,GAAW,WAAW,CAAC;IAmB1C,CAAC;IAjBQ,KAAK,CAAC,WAAwB,EAAE,UAA6B;QAClE,WAAW,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,EAAE,GAAG,EAAE;YACjD,WAAW,CAAC,sCAAsC,CAAC,oBAAoB,EAAE,CAAC,gBAAgB,EAAE,EAAE;gBAI5F,MAAM,EAAE,6BAA6B,EAAE,GAAG,gBAA+B,CAAC;gBAC1E,OAAO,IAAI,oCAAoC,CAAC,8BAA8B,CAAC;oBAC7E,kBAAkB,EAAE,6BAA6B,CAAC,kBAAkB;oBACpE,oBAAoB,EAAE,6BAA6B,CAAC,oBAAoB;oBACxE,gBAAgB,EAAE,6BAA6B,CAAC,gBAAgB;oBAChE,UAAU,EAAE,6BAA6B,CAAC,UAAU;oBACpD,mBAAmB,EAAE,CAAC,CAAC,6BAA6B,CAAC,mBAAmB;iBACzE,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC;CACF;AApBD,4EAoBC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport { Import } from '@rushstack/node-core-library';\nimport type { IRushPlugin, RushSession, RushConfiguration } from '@rushstack/rush-sdk';\nimport type { AzureEnvironmentNames } from './AzureStorageAuthentication';\n\nconst AzureStorageBuildCacheProviderModule: typeof import('./AzureStorageBuildCacheProvider') = Import.lazy(\n  './AzureStorageBuildCacheProvider',\n  require\n);\n\nconst PLUGIN_NAME: string = 'AzureStorageBuildCachePlugin';\n\n/**\n * @public\n */\ninterface IAzureBlobStorageConfigurationJson {\n  /**\n   * The name of the the Azure storage account to use for build cache.\n   */\n  storageAccountName: string;\n\n  /**\n   * The name of the container in the Azure storage account to use for build cache.\n   */\n  storageContainerName: string;\n\n  /**\n   * The Azure environment the storage account exists in. Defaults to AzureCloud.\n   */\n  azureEnvironment?: AzureEnvironmentNames;\n\n  /**\n   * An optional prefix for cache item blob names.\n   */\n  blobPrefix?: string;\n\n  /**\n   * If set to true, allow writing to the cache. Defaults to false.\n   */\n  isCacheWriteAllowed?: boolean;\n}\n\n/**\n * @public\n */\nexport class RushAzureStorageBuildCachePlugin implements IRushPlugin {\n  public pluginName: string = PLUGIN_NAME;\n\n  public apply(rushSession: RushSession, rushConfig: RushConfiguration): void {\n    rushSession.hooks.initialize.tap(PLUGIN_NAME, () => {\n      rushSession.registerCloudBuildCacheProviderFactory('azure-blob-storage', (buildCacheConfig) => {\n        type IBuildCache = typeof buildCacheConfig & {\n          azureBlobStorageConfiguration: IAzureBlobStorageConfigurationJson;\n        };\n        const { azureBlobStorageConfiguration } = buildCacheConfig as IBuildCache;\n        return new AzureStorageBuildCacheProviderModule.AzureStorageBuildCacheProvider({\n          storageAccountName: azureBlobStorageConfiguration.storageAccountName,\n          storageContainerName: azureBlobStorageConfiguration.storageContainerName,\n          azureEnvironment: azureBlobStorageConfiguration.azureEnvironment,\n          blobPrefix: azureBlobStorageConfiguration.blobPrefix,\n          isCacheWriteAllowed: !!azureBlobStorageConfiguration.isCacheWriteAllowed\n        });\n      });\n    });\n  }\n}\n"]}