{"version":3,"file":"InstallHelpers.js","sourceRoot":"","sources":["../../../src/logic/installManager/InstallHelpers.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport colors from 'colors/safe';\nimport * as os from 'os';\nimport * as path from 'path';\nimport { FileConstants, FileSystem, IPackageJson, JsonFile, LockFile } from '@rushstack/node-core-library';\n\nimport { LastInstallFlag } from '../../api/LastInstallFlag';\nimport { PackageManagerName } from '../../api/packageManager/PackageManager';\nimport { RushConfiguration, IConfigurationEnvironment } from '../../api/RushConfiguration';\nimport { RushGlobalFolder } from '../../api/RushGlobalFolder';\nimport { Utilities } from '../../utilities/Utilities';\n\nexport class InstallHelpers {\n  public static generateCommonPackageJson(\n    rushConfiguration: RushConfiguration,\n    dependencies: Map<string, string> = new Map<string, string>()\n  ): void {\n    const commonPackageJson: IPackageJson = {\n      dependencies: {},\n      description: 'Temporary file generated by the Rush tool',\n      name: 'rush-common',\n      private: true,\n      version: '0.0.0'\n    };\n\n    // Add any preferred versions to the top of the commonPackageJson\n    // do this in alphabetical order for simpler debugging\n    for (const dependency of Array.from(dependencies.keys()).sort()) {\n      commonPackageJson.dependencies![dependency] = dependencies.get(dependency)!;\n    }\n\n    // Example: \"C:\\MyRepo\\common\\temp\\package.json\"\n    const commonPackageJsonFilename: string = path.join(\n      rushConfiguration.commonTempFolder,\n      FileConstants.PackageJson\n    );\n\n    // Don't update the file timestamp unless the content has changed, since \"rush install\"\n    // will consider this timestamp\n    JsonFile.save(commonPackageJson, commonPackageJsonFilename, { onlyIfChanged: true });\n  }\n\n  public static getPackageManagerEnvironment(\n    rushConfiguration: RushConfiguration,\n    options: {\n      debug?: boolean;\n    } = {}\n  ): NodeJS.ProcessEnv {\n    let configurationEnvironment: IConfigurationEnvironment | undefined = undefined;\n\n    if (rushConfiguration.packageManager === 'npm') {\n      if (rushConfiguration.npmOptions && rushConfiguration.npmOptions.environmentVariables) {\n        configurationEnvironment = rushConfiguration.npmOptions.environmentVariables;\n      }\n    } else if (rushConfiguration.packageManager === 'pnpm') {\n      if (rushConfiguration.pnpmOptions && rushConfiguration.pnpmOptions.environmentVariables) {\n        configurationEnvironment = rushConfiguration.pnpmOptions.environmentVariables;\n      }\n    } else if (rushConfiguration.packageManager === 'yarn') {\n      if (rushConfiguration.yarnOptions && rushConfiguration.yarnOptions.environmentVariables) {\n        configurationEnvironment = rushConfiguration.yarnOptions.environmentVariables;\n      }\n    }\n\n    return InstallHelpers._mergeEnvironmentVariables(process.env, configurationEnvironment, options);\n  }\n\n  /**\n   * If the \"(p)npm-local\" symlink hasn't been set up yet, this creates it, installing the\n   * specified (P)npm version in the user's home directory if needed.\n   */\n  public static async ensureLocalPackageManager(\n    rushConfiguration: RushConfiguration,\n    rushGlobalFolder: RushGlobalFolder,\n    maxInstallAttempts: number,\n    restrictConsoleOutput?: boolean\n  ): Promise<void> {\n    let logIfConsoleOutputIsNotRestricted: (message?: string) => void;\n    if (restrictConsoleOutput) {\n      logIfConsoleOutputIsNotRestricted = () => {\n        /* noop */\n      };\n    } else {\n      logIfConsoleOutputIsNotRestricted = (message?: string) => {\n        console.log(message);\n      };\n    }\n\n    // Example: \"C:\\Users\\YourName\\.rush\"\n    const rushUserFolder: string = rushGlobalFolder.nodeSpecificPath;\n\n    if (!FileSystem.exists(rushUserFolder)) {\n      logIfConsoleOutputIsNotRestricted('Creating ' + rushUserFolder);\n      FileSystem.ensureFolder(rushUserFolder);\n    }\n\n    const packageManager: PackageManagerName = rushConfiguration.packageManager;\n    const packageManagerVersion: string = rushConfiguration.packageManagerToolVersion;\n\n    const packageManagerAndVersion: string = `${packageManager}-${packageManagerVersion}`;\n    // Example: \"C:\\Users\\YourName\\.rush\\pnpm-1.2.3\"\n    const packageManagerToolFolder: string = path.join(rushUserFolder, packageManagerAndVersion);\n\n    const packageManagerMarker: LastInstallFlag = new LastInstallFlag(packageManagerToolFolder, {\n      node: process.versions.node\n    });\n\n    logIfConsoleOutputIsNotRestricted(`Trying to acquire lock for ${packageManagerAndVersion}`);\n\n    const lock: LockFile = await LockFile.acquire(rushUserFolder, packageManagerAndVersion);\n\n    logIfConsoleOutputIsNotRestricted(`Acquired lock for ${packageManagerAndVersion}`);\n\n    if (!packageManagerMarker.isValid() || lock.dirtyWhenAcquired) {\n      logIfConsoleOutputIsNotRestricted(\n        colors.bold(`Installing ${packageManager} version ${packageManagerVersion}${os.EOL}`)\n      );\n\n      // note that this will remove the last-install flag from the directory\n      Utilities.installPackageInDirectory({\n        directory: packageManagerToolFolder,\n        packageName: packageManager,\n        version: rushConfiguration.packageManagerToolVersion,\n        tempPackageTitle: `${packageManager}-local-install`,\n        maxInstallAttempts: maxInstallAttempts,\n        // This is using a local configuration to install a package in a shared global location.\n        // Generally that's a bad practice, but in this case if we can successfully install\n        // the package at all, we can reasonably assume it's good for all the repositories.\n        // In particular, we'll assume that two different NPM registries cannot have two\n        // different implementations of the same version of the same package.\n        // This was needed for: https://github.com/microsoft/rushstack/issues/691\n        commonRushConfigFolder: rushConfiguration.commonRushConfigFolder\n      });\n\n      logIfConsoleOutputIsNotRestricted(\n        `Successfully installed ${packageManager} version ${packageManagerVersion}`\n      );\n    } else {\n      logIfConsoleOutputIsNotRestricted(\n        `Found ${packageManager} version ${packageManagerVersion} in ${packageManagerToolFolder}`\n      );\n    }\n\n    packageManagerMarker.create();\n\n    // Example: \"C:\\MyRepo\\common\\temp\"\n    FileSystem.ensureFolder(rushConfiguration.commonTempFolder);\n\n    // Example: \"C:\\MyRepo\\common\\temp\\pnpm-local\"\n    const localPackageManagerToolFolder: string = path.join(\n      rushConfiguration.commonTempFolder,\n      `${packageManager}-local`\n    );\n\n    logIfConsoleOutputIsNotRestricted(os.EOL + `Symlinking \"${localPackageManagerToolFolder}\"`);\n    logIfConsoleOutputIsNotRestricted(`  --> \"${packageManagerToolFolder}\"`);\n\n    // We cannot use FileSystem.exists() to test the existence of a symlink, because it will\n    // return false for broken symlinks.  There is no way to test without catching an exception.\n    try {\n      FileSystem.deleteFolder(localPackageManagerToolFolder);\n    } catch (error) {\n      if ((error as NodeJS.ErrnoException).code !== 'ENOENT') {\n        throw error;\n      }\n    }\n\n    FileSystem.createSymbolicLinkJunction({\n      linkTargetPath: packageManagerToolFolder,\n      newLinkPath: localPackageManagerToolFolder\n    });\n\n    lock.release();\n  }\n\n  // Helper for getPackageManagerEnvironment\n  private static _mergeEnvironmentVariables(\n    baseEnv: NodeJS.ProcessEnv,\n    environmentVariables?: IConfigurationEnvironment,\n    options: {\n      debug?: boolean;\n    } = {}\n  ): NodeJS.ProcessEnv {\n    const packageManagerEnv: NodeJS.ProcessEnv = baseEnv;\n\n    if (environmentVariables) {\n      // eslint-disable-next-line guard-for-in\n      for (const envVar in environmentVariables) {\n        let setEnvironmentVariable: boolean = true;\n        console.log(`\\nProcessing definition for environment variable: ${envVar}`);\n\n        if (baseEnv.hasOwnProperty(envVar)) {\n          setEnvironmentVariable = false;\n          console.log(`Environment variable already defined:`);\n          console.log(`  Name: ${envVar}`);\n          console.log(`  Existing value: ${baseEnv[envVar]}`);\n          console.log(`  Value set in rush.json: ${environmentVariables[envVar].value}`);\n\n          if (environmentVariables[envVar].override) {\n            setEnvironmentVariable = true;\n            console.log(`Overriding the environment variable with the value set in rush.json.`);\n          } else {\n            console.log(colors.yellow(`WARNING: Not overriding the value of the environment variable.`));\n          }\n        }\n\n        if (setEnvironmentVariable) {\n          if (options.debug) {\n            console.log(`Setting environment variable for package manager.`);\n            console.log(`  Name: ${envVar}`);\n            console.log(`  Value: ${environmentVariables[envVar].value}`);\n          }\n          packageManagerEnv[envVar] = environmentVariables[envVar].value;\n        }\n      }\n    }\n\n    return packageManagerEnv;\n  }\n}\n"]}