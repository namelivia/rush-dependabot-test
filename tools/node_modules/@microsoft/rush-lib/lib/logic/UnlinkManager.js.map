{"version":3,"file":"UnlinkManager.js","sourceRoot":"","sources":["../../src/logic/UnlinkManager.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE3D,uDAAiC;AACjC,2CAA6B;AAC7B,oEAAgF;AAGhF,sDAAmD;AACnD,gFAA6E;AAC7E,sDAA0D;AAE1D;;GAEG;AACH,MAAa,aAAa;IAGxB,YAAmB,iBAAoC;QACrD,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;IAC9C,CAAC;IAED;;;;;OAKG;IACI,MAAM,CAAC,QAAiB,KAAK;QAClC,MAAM,aAAa,GACjB,IAAI,CAAC,kBAAkB,CAAC,WAAW,IAAI,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,aAAa,CAAC;QAC3F,IAAI,CAAC,KAAK,IAAI,aAAa,EAAE;YAC3B,OAAO,CAAC,GAAG,CACT,cAAM,CAAC,GAAG,CACR,+EAA+E;gBAC7E,+BAA+B,CAClC,CACF,CAAC;YACF,MAAM,IAAI,wCAAoB,EAAE,CAAC;SAClC;QAED,kCAAmB,CAAC,iBAAiB,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC,KAAK,EAAE,CAAC;QACvE,OAAO,IAAI,CAAC,mBAAmB,EAAE,CAAC;IACpC,CAAC;IAED;;;;;;SAMK;IACG,mBAAmB;QACzB,IAAI,iBAAiB,GAAY,KAAK,CAAC;QAEvC,KAAK,MAAM,WAAW,IAAI,IAAI,CAAC,kBAAkB,CAAC,QAAQ,EAAE;YAC1D,MAAM,iBAAiB,GAAW,IAAI,CAAC,IAAI,CAAC,WAAW,CAAC,aAAa,EAAE,cAAc,CAAC,CAAC;YACvF,IAAI,8BAAU,CAAC,MAAM,CAAC,iBAAiB,CAAC,EAAE;gBACxC,OAAO,CAAC,GAAG,CAAC,WAAW,iBAAiB,EAAE,CAAC,CAAC;gBAC5C,qBAAS,CAAC,qBAAqB,CAAC,iBAAiB,CAAC,CAAC;gBACnD,iBAAiB,GAAG,IAAI,CAAC;aAC1B;YAED,MAAM,yBAAyB,GAAW,qDAAyB,CAAC,qBAAqB,CAAC,WAAW,CAAC,CAAC;YACvG,IAAI,8BAAU,CAAC,MAAM,CAAC,yBAAyB,CAAC,EAAE;gBAChD,OAAO,CAAC,GAAG,CAAC,YAAY,yBAAyB,EAAE,CAAC,CAAC;gBACrD,8BAAU,CAAC,UAAU,CAAC,yBAAyB,CAAC,CAAC;gBACjD,iBAAiB,GAAG,IAAI,CAAC;aAC1B;SACF;QAED,OAAO,iBAAiB,CAAC;IAC3B,CAAC;CACF;AA1DD,sCA0DC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport colors from 'colors/safe';\nimport * as path from 'path';\nimport { FileSystem, AlreadyReportedError } from '@rushstack/node-core-library';\n\nimport { RushConfiguration } from '../api/RushConfiguration';\nimport { Utilities } from '../utilities/Utilities';\nimport { BaseProjectShrinkwrapFile } from './base/BaseProjectShrinkwrapFile';\nimport { LastLinkFlagFactory } from '../api/LastLinkFlag';\n\n/**\n * This class implements the logic for \"rush unlink\"\n */\nexport class UnlinkManager {\n  private _rushConfiguration: RushConfiguration;\n\n  public constructor(rushConfiguration: RushConfiguration) {\n    this._rushConfiguration = rushConfiguration;\n  }\n\n  /**\n   * Delete flag file and all the existing node_modules symlinks and all\n   * project/.rush/temp/shrinkwrap-deps.json files\n   *\n   * Returns true if anything was deleted.\n   */\n  public unlink(force: boolean = false): boolean {\n    const useWorkspaces: boolean =\n      this._rushConfiguration.pnpmOptions && this._rushConfiguration.pnpmOptions.useWorkspaces;\n    if (!force && useWorkspaces) {\n      console.log(\n        colors.red(\n          'Unlinking is not supported when using workspaces. Run \"rush purge\" to remove ' +\n            'project node_modules folders.'\n        )\n      );\n      throw new AlreadyReportedError();\n    }\n\n    LastLinkFlagFactory.getCommonTempFlag(this._rushConfiguration).clear();\n    return this._deleteProjectFiles();\n  }\n\n  /**\n   * Delete:\n   *  - all the node_modules symlinks of configured Rush projects\n   *  - all of the project/.rush/temp/shrinkwrap-deps.json files of configured Rush projects\n   *\n   * Returns true if anything was deleted\n   * */\n  private _deleteProjectFiles(): boolean {\n    let didDeleteAnything: boolean = false;\n\n    for (const rushProject of this._rushConfiguration.projects) {\n      const localModuleFolder: string = path.join(rushProject.projectFolder, 'node_modules');\n      if (FileSystem.exists(localModuleFolder)) {\n        console.log(`Purging ${localModuleFolder}`);\n        Utilities.dangerouslyDeletePath(localModuleFolder);\n        didDeleteAnything = true;\n      }\n\n      const projectShrinkwrapFilePath: string = BaseProjectShrinkwrapFile.getFilePathForProject(rushProject);\n      if (FileSystem.exists(projectShrinkwrapFilePath)) {\n        console.log(`Deleting ${projectShrinkwrapFilePath}`);\n        FileSystem.deleteFile(projectShrinkwrapFilePath);\n        didDeleteAnything = true;\n      }\n    }\n\n    return didDeleteAnything;\n  }\n}\n"]}